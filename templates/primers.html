{% extends 'base.html' %}

{% block content %}
<style>
    /* Hier können Sie Ihre zusätzlichen Stile für die Tabelle und andere Elemente hinzufügen */
    #primerListTable, #primerListTable thead, #primerListTable tbody, #primerListTable tfoot, #primerListTable tr, #primerListTable th, #primerListTable td {
        border: none !important;
        border-collapse: collapse;
    }

    #primerListTable .group {
        font-weight: bold;
        text-decoration: underline;
    }

    #primerListTable tr:hover {
        background-color: inherit !important;
    }

    #primerListTable tr {
        background-color: white !important;
    }

    .menu-list {
        border: none !important;
        box-shadow: none !important;
    }

    .dataTables_scroll {
        border: none !important;
    }

    tr.selected {
        background-color: hsl(204, 86%, 53%) !important;
    }

    #primerListTable {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    #primerListTable tbody tr.selected td {
        background-color: hsl(204, 86%, 53%) !important;
    }

    .sidebar {
        float: left;
        padding: 1em 2em 1em 0;
    }

    .sidebar:first-of-type {
        width: 20%;
    }

    .sidebar:last-of-type {
        width: 80%;
    }
</style>

<div class="sidebar">
    <aside class="menu">
        <p class="menu-label">
            Primer Lists
        </p>
        <ul class="menu-list">
            <table id="primerListTable" class="table is-fullwidth">
                <tbody>
                    {% for primer_list in primer_lists %}
                        {% if primer_list.visibility == 'public' or (primer_list.visibility == 'private' and primer_list.user_id == current_user.id) %}
                            <tr data-primer-list-id="{{ primer_list.id }}">
                                <td>{{ primer_list.name }}</td>
                                <td>{{ primer_list.visibility }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </ul>
    </aside>
</div>

<div class="sidebar">
    <aside class="menu">
        <p class="menu-label">
            Primers
        </p>
        <ul class="menu-list">
            <table id="PrimerTable" class="table is-fullwidth">
                <thead>
                    <tr>
                        <th>Application</th>
                        <th>PCR</th>
                        <th>Target</th>
                        <th>Oligos</th>
                        <th>Sequence</th>
                        <th>Box</th>
                        <th>Position</th>
                        <th>Reference</th>
                        <th>Comment</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </ul>
    </aside>
</div>

<div class="content" style="clear: both;">
</div>
{% endblock %}

{% block scripts %}
<script>
    var groupColumn = 1;
    var table = $('#primerListTable').DataTable({
        columnDefs: [{ visible: false, targets: groupColumn }],
        order: [[groupColumn, 'asc']],
        paging: false,
        searching: false,
        bInfo: false,
        ordering: false,
        scrollCollapse: true,
        scrollY: '50vh',
        drawCallback: function (settings) {
            var api = this.api();
            var rows = api.rows({ page: 'current' }).nodes();
            var last = null;

            api.column(groupColumn, { page: 'current' })
                .data()
                .each(function (group, i) {
                    if (last !== group) {
                        $(rows)
                            .eq(i)
                            .before(
                                '<tr class="group"><td colspan="2">' +
                                    group +
                                    '</td></tr>'
                            );

                        last = group;
                    }
                });
        }
    });

    $('#primerListTable tbody').on('click', 'tr:not(.group)', function() {
        console.log("Row clicked!");

        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        } else {
            $('#primerListTable tbody tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }

        console.log("Selected class status:", $(this).hasClass('selected'));

        var primerListId = $(this).data('primer-list-id');
        $.ajax({
            url: '/get-primers-for-list/' + primerListId,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                var newTable = $('#PrimerTable').DataTable();
                newTable.clear().draw();
                console.log(data);
                console.log("Is Array? ", data.constructor === Array);
                if (data.constructor === Array) {
                    data.forEach(function(primer) {
                        newTable.row.add([
                            primer.application,
                            primer.pcr,
                            primer.target,
                            primer.oligos,
                            primer.sequence,
                            primer.box,
                            primer.position,
                            primer.reference,
                            primer.comment
                        ]).draw();
                    });
                } else {
                    console.error("Received data is not an array:", data);
                }
            },

            error: function(error) {
                console.error("Error fetching associated primers:", error);
            }
        });
    });

    var editor = new $.fn.dataTable.Editor({
        ajax: {
            create: {
                type: 'POST',
                url:  '/editor'
            },
            edit: {
                type: 'POST',
                url:  '/editor/_id_'
            },
            remove: {
                type: 'POST',
                url:  '/editor/_id_'
            }
        },
        table: "#PrimerTable",
        fields: [
            { label: "Application", name: "application" },
            { label: "PCR", name: "pcr" },
            { label: "Target", name: "target" },
            { label: "Oligos", name: "oligos" },
            { label: "Sequence", name: "sequence" },
            { label: "Box", name: "box" },
            { label: "Position", name: "position" },
            { label: "Reference", name: "reference" },
            { label: "Comment", name: "comment" }
        ]
    });

    $('#PrimerTable').DataTable({
    dom: "Bfrtip",
    ajax: {
        url: "/get-primers-for-list/1", // Ändern Sie diese URL entsprechend Ihrem Setup
        type: "GET",
        dataSrc: "data" // Hier weisen Sie DataTables an, dass die Daten unter dem Schlüssel "data" im Antwortobjekt zu finden sind.
    },
    columns: [
        { data: "application" },
        { data: "pcr" },
        { data: "target" },
        { data: "oligos" },
        { data: "sequence" },
        { data: "box" },
        { data: "position" },
        { data: "reference" },
        { data: "comment" }
    ],
    select: true,
    buttons: [
        { extend: "create", editor: editor },
        { extend: "edit",   editor: editor },
        { extend: "remove", editor: editor }
    ],
    paging: false,
    searching: false,
    bInfo: false,
    ordering: false,
    scrollCollapse: true,
    scrollY: '50vh'
});

</script>
{% endblock %}
