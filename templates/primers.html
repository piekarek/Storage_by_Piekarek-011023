{% extends "base.html" %}

{% block content %}
<h2 class="is-size-5 custom-heading">Primers</h2>
<div class="content-wrapper">
    <!-- Sidebar for displaying Primer Lists -->
    <aside class="primer-lists-sidebar menu">
        <p class="menu-label">
            Primer-Listen
        </p>
        <ul class="menu-list" id="primerLists"></ul>
        <div class="field">
            <input class="input" type="text" placeholder="Neue Liste" id="newListName">
        </div>
        <div class="field">
            <label class="radio">
                <input type="radio" name="listVisibility" value="private" checked> Privat
            </label>
            <label class="radio">
                <input type="radio" name="listVisibility" value="public"> √ñffentlich
            </label>
        </div>
        <div class="field">
            <button class="button is-success" id="createNewListButton">Erstellen</button>
        </div>
    </aside>

    <!-- Primers Table -->
    <div class="primer-table-container">
        <div class="buttons">
            <a href="{{ url_for('add_primer') }}" class="button is-primary">Neu</a>
            <button id="delete-button" class="button is-danger">L√∂schen</button>
            <button type="button" class="button is-success" id="addToListButton">Zur Liste hinzuf√ºgen</button>
        </div>
        <table class="table is-fullwidth is-striped is-spaced is-hoverable" id="primers-table">
            <thead>
                <tr>
                    <th style="text-align:center;"><input type="checkbox" id="select-all"></th>
                    <th>ID</th>
                    <th>Anwendung</th>
                    <th>PCR</th>
                    <th>Ziel</th>
                    <th>Oligos</th>
                    <th>Sequenz</th>
                    <th>Box</th>
                    <th>Position</th>
                    <th>Referenz</th>
                    <th>Kommentar</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for primer in primers %}
                <tr>
                    <td style="text-align:center;"><input type="checkbox" class="primer-checkbox" value="{{ primer.id }}"></td>
                    <td>{{ primer.id }}</td>
                    <td>{{ primer.application }}</td>
                    <td>{{ primer.pcr }}</td>
                    <td>{{ primer.target }}</td>
                    <td>{{ primer.oligos }}</td>
                    <td>{{ primer.sequence }}</td>
                    <td>{{ primer.box }}</td>
                    <td>{{ primer.position }}</td>
                    <td>{{ primer.reference }}</td>
                    <td>{{ primer.comment }}</td>
                    <td>
                        <a href="{{ url_for('edit_primer', primer_id=primer.id) }}" class="button is-small is-primary">Bearbeiten</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dataTable = $('#primers-table').DataTable({
            lengthMenu: [[10, 25, 50, 100, 150, 200, 500, -1], [10, 25, 50, 100, 150, 200, 500, "Alle"]],
            displayLength: 100,
            dom: "<'row'<'col-sm-12'fB>>" +
                 "<'row'<'col-sm-12'tr>>" +
                 "<'row'<'col-sm-12 col-md-5'li><'col-sm-12 col-md-7'p>>",
            buttons: [
                'copy',
                { extend: 'csv', text: 'Export CSV' },
                { extend: 'excel', text: 'Export Excel' },
                { extend: 'pdf', text: 'Export PDF' },
                { extend: 'print', text: 'Drucken' }
            ],
            columnDefs: [ { orderable: false, targets: [0, 11] }, { visible: false, targets: [1] } ],
            order: [[5, 'asc']]
        });

        document.getElementById('select-all').addEventListener('click', function() {
            var checkboxes = dataTable.$('.primer-checkbox');
            var isChecked = this.checked;
            checkboxes.each(function() {
                this.checked = isChecked;
            });
        });

        document.getElementById('primers-table').addEventListener('mousedown', function(event) {
            event.preventDefault();
        }, false);

        function deletePrimerList(listId) {
            if (confirm("M√∂chten Sie diese Liste wirklich l√∂schen?")) {
                fetch('/delete_primer_list/' + listId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Liste erfolgreich gel√∂scht!');
                        loadPrimerLists();
                    } else {
                        alert('Fehler beim L√∂schen der Liste: ' + data.message);
                    }
                });
            }
        }

        function loadPrimerLists() {
            fetch('/get_primer_lists', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const primerListsContainer = document.getElementById('primerLists');
                primerListsContainer.innerHTML = '<li><b>PRIMER STOCK</b></li><li>Alle</li>';

                primerListsContainer.innerHTML += '<br><li><b>√ñffentlich</b></li>';
                data.public_lists.forEach(list => {
                    const listItem = document.createElement('li');
                    const deleteIcon = document.createElement('span');
                    deleteIcon.innerHTML = 'üóëÔ∏è';
                    deleteIcon.style.cursor = 'pointer';
                    deleteIcon.addEventListener('click', function() {
                        deletePrimerList(list.id);
                    });
                    listItem.textContent = list.name + ' ';
                    listItem.appendChild(deleteIcon);
                    primerListsContainer.appendChild(listItem);
                });

                primerListsContainer.innerHTML += '<br><li><b>Privat</b></li>';
                data.private_lists.forEach(list => {
                    const listItem = document.createElement('li');
                    const deleteIcon = document.createElement('span');
                    deleteIcon.innerHTML = 'üóëÔ∏è';
                    deleteIcon.style.cursor = 'pointer';
                    deleteIcon.addEventListener('click', function() {
                        deletePrimerList(list.id);
                    });
                    listItem.textContent = list.name + ' ';
                    listItem.appendChild(deleteIcon);
                    primerListsContainer.appendChild(listItem);
                });
            });
        }

        loadPrimerLists();

        document.getElementById('createNewListButton').addEventListener('click', function() {
            const newListName = document.getElementById('newListName').value;
            const visibility = document.querySelector('input[name="listVisibility"]:checked').value;

            if (!newListName) {
                alert('Bitte geben Sie einen Namen f√ºr die neue Liste ein.');
                return;
            }

            fetch('/create_primer_list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: newListName,
                    visibility: visibility
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Neue Liste erfolgreich erstellt!');
                    loadPrimerLists();
                } else {
                    alert('Fehler beim Erstellen der neuen Liste: ' + data.message);
                }
            });
        });
    });
</script>
{% endblock %}
